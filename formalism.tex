\documentclass{article}
\input{preamble/preamble}
\usepackage[margin=1in]{geometry}

\begin{document}
\renewcommand{\thesection}{\Alph{section}}
\section{Formalism}
Formalization of hole-fixing semantics.

\subsection{Syntax}
\[\begin{array}{rrcl}
  \TMName  & \TMV  & \Coloneqq & \TUnknown \mid \TInt \mid \TBool \mid \TArrow{\TMV}{\TMV} \\
  \EMName  & \EMV  & \Coloneqq & \EEHole \mid x \mid \ELam{x}{\TMV}{\EMV} \mid \EAp{\EMV}{\EMV} \\
           &       & \mid         & \EIntMV \mid \EPlus{\EMV}{\EMV} \\
           &       & \mid         & \ETrue \mid \EFalse \mid \EIf{\EMV}{\EMV}{\EMV} \\
  \ECMName & \ECMV & \Coloneqq & \ECEHole \mid x \mid \ECLam{x}{\TMV}{\ECMV} \mid \ECAp{\ECMV}{\ECMV} \\
           &       & \mid         & \ECIntMV \mid \ECPlus{\ECMV}{\ECMV} \\
           &       & \mid         & \ECTrue \mid \ECFalse \mid \ECIf{\ECMV}{\ECMV}{\ECMV} \\
           &       & \mid         & \ECUnbound{x} \mid \ECInconType{\ECMV} \mid \ECInconBr{\ECMV}{\ECMV}{\ECMV}
\end{array}\]

\subsection{Types}
\judgbox{\ensuremath{\consistent{\TMV_1}{\TMV_2}}} $\TMV_1$ is consistent with $\TMV_2$
%
\begin{mathpar}
  \judgment{ }{
    \consistent{\TUnknown}{\TMV}
  }{TCUnknown1}

  \judgment{ }{
    \consistent{\TMV}{\TUnknown}
  }{TCUnknown2}

  \judgment{ }{
    \consistent{\TMV}{\TMV}
  }{TCRefl}

  \judgment{
    \consistent{\TMV_1}{\TMV_1'} \\
    \consistent{\TMV_2}{\TMV_2'} \\
  }{
    \consistent{\TArrow{\TMV_1}{\TMV_2}}{\TArrow{\TMV_1'}{\TMV_2'}}
  }{TCArr}
\end{mathpar} \\

\judgbox{\ensuremath{\matchedArrow{\TMV}{\TMV_1}{\TMV_2}}} $\TMV$ has matched arrow type
$\TArrow{\TMV_1}{\TMV_2}$
%
\begin{mathpar}
  \judgment{ }{
    \matchedArrow{\TUnknown}{\TUnknown}{\TUnknown}
  }{TMAHole}

  \judgment{ }{
    \matchedArrow{\TArrow{\TMV}{\TMV}}{\TMV}{\TMV}
  }{TMAArrow}
\end{mathpar} \\

\judgbox{\ensuremath{\TJoin{\TMV_1}{\TMV_2} = \TMV}} is a \emph{partial} metafunction defined as
follows:
%
\newcommand{\joinsTo}[3]{\ensuremath{\TJoin{#1}{#2} & = & #3}}
\[\begin{array}{rcl}
  & \vdots &
\end{array}\]

\subsection{Hole Insertion}
\judgbox{\ctxSynFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}} $\EMV$ is marked into $\ECMV$ and
synthesizes type $\TMV$
%
\begin{mathpar}
  \judgment{ }{
    \ctxSynFixedInto{\ctx}{\EEHole}{\ECEHole}{\TUnknown}
  }{FSHole}

  \judgment{
    \inCtx{\ctx}{x}{\TMV}
  }{
    \ctxSynFixedInto{\ctx}{x}{x}{\TMV}
  }{FSVar}

  \judgment{
    \notInCtx{\ctx}{x}
  }{
    \ctxSynFixedInto{\ctx}{x}{\ECUnbound{x}}{\TUnknown}
  }{FSUnbound}

  \judgment{
    \ctxSynFixedInto{\extendCtx{\ctx}{x}{\TMV_1}}{\EMV}{\ECMV}{\TMV_2}
  }{
    \ctxSynFixedInto{\ctx}{\ELam{x}{\TMV_1}{\EMV}}{\ELam{x}{\TMV_1}{\ECMV}}{\TArrow{\TMV_1}{\TMV_2}}
  }{FSLam}

  \judgment{
    \ctxSynFixedInto{\ctx}{\EMV_1}{\ECMV_1}{\TMV} \\
    \matchedArrow{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaFixedInto{\ctx}{\EMV_2}{\ECMV_2}{\TMV_1} \\
  }{
    \ctxSynFixedInto{\ctx}{\EAp{\EMV_1}{\EMV_2}}{\ECAp{\ECMV_1}{\ECMV_2}}{\TMV_2}
  }{FSAp1}

  \judgment{
    \ctxSynFixedInto{\ctx}{\EMV_1}{\ECMV_1}{\TMV} \\
    \notMatchedArrow{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaFixedInto{\ctx}{\EMV_2}{\ECMV_2}{\TUnknown}
  }{
    \ctxSynFixedInto{\ctx}{\EAp{\EMV_1}{\EMV_2}}{\ECAp{\ECInconType{\ECMV_1}}{\ECMV_2}}{\TUnknown}
  }{FSAp2}

  \judgment{
  }{
    \ctxSynFixedInto{\ctx}{\EIntMV}{\ECIntMV}{\TInt}
  }{FSNum}

  \judgment{
    \ctxAnaFixedInto{\ctx}{\EMV_1}{\ECMV_1}{\TInt} \\
    \ctxAnaFixedInto{\ctx}{\EMV_2}{\ECMV_2}{\TInt}
  }{
    \ctxSynFixedInto{\ctx}{\EPlus{\EMV_1}{\EMV_2}}{\ECPlus{\ECMV_1}{\ECMV_2}}{\TInt}
  }{FSPlus}

  \judgment{
  }{
    \ctxSynFixedInto{\ctx}{\ETrue}{\ECTrue}{\TBool}
  }{FSTrue}

  \judgment{
  }{
    \ctxSynFixedInto{\ctx}{\EFalse}{\ECFalse}{\TBool}
  }{FSFalse}

  \judgment{
    \ctxAnaFixedInto{\ctx}{\EMV_1}{\ECMV_1}{\TBool} \\
    \ctxSynFixedInto{\ctx}{\EMV_2}{\ECMV_2}{\TMV_1} \\
    \ctxSynFixedInto{\ctx}{\EMV_3}{\ECMV_3}{\TMV_2}
  }{
    \ctxSynFixedInto{\ctx}{\EIf{\EMV_1}{\EMV_2}{\EMV_3}}{\ECIf{\ECMV_1}{\ECMV_2}{\ECMV_3}}{\TJoin{\TMV_1}{\TMV_2}}
  }{FSIf}

  \judgment{
    \ctxAnaFixedInto{\ctx}{\EMV_1}{\ECMV_1}{\TBool} \\
    \ctxSynFixedInto{\ctx}{\EMV_2}{\ECMV_2}{\TMV_1} \\
    \ctxSynFixedInto{\ctx}{\EMV_3}{\ECMV_3}{\TMV_2} \\
    \inconsistent{\TMV_1}{\TMV_2}
  }{
    \ctxSynFixedInto{\ctx}{\EIf{\EMV_1}{\EMV_2}{\EMV_3}}{\ECInconBr{\ECMV_1}{\ECMV_2}{\ECMV_3}}{\TUnknown}
  }{FSInconsistentBranches}
\end{mathpar} \\

\judgbox{\ctxAnaFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}} $\EMV$ is marked into $\ECMV$ and analyzes
against type $\TMV$
%
\begin{mathpar}
  \judgment{
    \matchedArrow{\TMV_3}{\TMV_1}{\TMV_2} \\
    \consistent{\TMV}{\TMV_1} \\
    \ctxAnaFixedInto{\extendCtx{\ctx}{x}{\TMV}}{\EMV}{\ECMV}{\TMV_2}
  }{
    \ctxAnaFixedInto{\ctx}{\ELam{x}{\TMV}{\EMV}}{\ECLam{x}{\TMV}{\ECMV}}{\TMV_3}
  }{FALam}

  \judgment{
    \ctxAnaFixedInto{\ctx}{\EMV_1}{\ECMV_1}{\TBool} \\
    \ctxAnaFixedInto{\ctx}{\EMV_2}{\ECMV_2}{\TMV} \\
    \ctxAnaFixedInto{\ctx}{\EMV_3}{\ECMV_3}{\TMV} \\
  }{
    \ctxAnaFixedInto{\ctx}{\EIf{\EMV_1}{\EMV_2}{\EMV_3}}{\ECIf{\ECMV_1}{\ECMV_2}{\ECMV_3}}{\TMV}
  }{FAIf}

  \judgment{
    \ctxSynFixedInto{\ctx}{\EMV}{\ECMV}{\TMV'} \\
    \inconsistent{\TMV}{\TMV'}
  }{
    \ctxAnaFixedInto{\ctx}{\EMV}{\ECInconType{\ECMV}}{\TMV}
  }{FAInconsistentTypes}

  \judgment{
    \ctxSynFixedInto{\ctx}{\EMV}{\ECMV}{\TMV'} \\
    \consistent{\TMV}{\TMV'}
  }{
    \ctxAnaFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}
  }{FASubsume}
\end{mathpar}

\subsection{Marked Expressions}
\judgbox{\ctxSynType{\ctx}{\ECMV}{\TMV}} $\ECMV$ synthesizes type $\TMV$
%
\begin{mathpar}
  \judgment{ }{
    \ctxSynType{\ctx}{\ECEHole}{\TUnknown}
  }{MSHole}

  \judgment{ }{
    \ctxSynType{\extendCtx{\ctx}{x}{\TMV}}{x}{\TMV}
  }{MSVar}

  \judgment{
    \ctxSynType{\extendCtx{\ctx}{x}{\TMV}}{\ECMV}{\TMV_2}
  }{
    \ctxSynType{\ctx}{\ECLam{x}{\TMV_1}{\ECMV}}{\TArrow{\TMV_1}{\TMV_2}}
  }{MSLam}

  \judgment{
    \ctxSynType{\ctx}{\ECMV_1}{\TMV} \\
    \matchedArrow{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaType{\ctx}{\ECMV_2}{\TMV_1}
  }{
    \ctxSynType{\ctx}{\ECAp{\ECMV_1}{\ECMV_2}}{\TMV_2}
  }{MSAp1}

  \judgment{
    \ctxSynType{\ctx}{\ECMV_1}{\TMV} \\
    \notMatchedArrow{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaType{\ctx}{\ECMV_2}{\TUnknown}
  }{
    \ctxSynType{\ctx}{\ECAp{\ECInconType{\ECMV_1}}{\ECMV_2}}{\TUnknown}
  }{MSAp2}

  \judgment{ }{
    \ctxSynType{\ctx}{\ECIntMV}{\TInt}
  }{MSNum}

  \judgment{
    \ctxAnaType{\ctx}{\ECMV_1}{\TInt} \\
    \ctxAnaType{\ctx}{\ECMV_2}{\TInt}
  }{
    \ctxSynType{\ctx}{\ECPlus{\ECMV_1}{\ECMV_2}}{\TInt}
  }{MSPlus}

  \judgment{ }{
    \ctxSynType{\ctx}{\ECTrue}{\TBool}
  }{MSTrue}

  \judgment{ }{
    \ctxSynType{\ctx}{\ECFalse}{\TBool}
  }{MSFalse}

  \judgment{
    \ctxAnaType{\ctx}{\ECMV_1}{\TBool} \\
    \ctxSynType{\ctx}{\ECMV_2}{\TMV_1} \\
    \ctxSynType{\ctx}{\ECMV_3}{\TMV_2}
  }{
    \ctxSynType{\ctx}{\ECIf{\ECMV_1}{\ECMV_2}{\ECMV_3}}{\TJoin{\TMV_1}{\TMV_2}}
  }{MSIf}

  \judgment{
    \notInCtx{\ctx}{x}
  }{
    \ctxSynType{\ctx}{\ECUnbound{x}}{\TUnknown}
  }{MSUnbound}

  \judgment{
    \ctxAnaType{\ctx}{\ECMV_1}{\TBool} \\
    \ctxSynType{\ctx}{\ECMV_1}{\TMV_1} \\
    \ctxSynType{\ctx}{\ECMV_2}{\TMV_2} \\
    \inconsistent{\TMV_1}{\TMV_2}
  }{
    \ctxAnaType{\ctx}{\ECInconBr{\ECMV_1}{\ECMV_2}{\ECMV_3}}{\TUnknown}
  }{MSInconsistentBranches}
\end{mathpar} \\

\judgbox{\ctxAnaType{\ctx}{\ECMV}{\TMV}} $\ECMV$ analyzes against type $\TMV$
%
\begin{mathpar}
  \judgment{
    \matchedArrow{\TMV_3}{\TMV_1}{\TMV_2} \\
    \consistent{\TMV}{\TMV_1} \\
    \ctxAnaType{\extendCtx{\ctx}{x}{\TMV}}{\ECMV}{\TMV_2}
  }{
    \ctxAnaType{\ctx}{\ECLam{x}{\TMV}{\ECMV}}{\TMV_3}
  }{MALam}

  \judgment{
    \ctxAnaType{\ctx}{\ECMV_1}{\TBool} \\
    \ctxAnaType{\ctx}{\ECMV_1}{\TMV} \\
    \ctxAnaType{\ctx}{\ECMV_2}{\TMV}
  }{
    \ctxAnaType{\ctx}{\ECIf{\ECMV_1}{\ECMV_2}{\ECMV_3}}{\TMV}
  }{MAIf}

  \judgment{
    \ctxSynType{\ctx}{\ECMV}{\TMV'} \\
    \inconsistent{\TMV}{\TMV'}
  }{
    \ctxAnaType{\ctx}{\ECInconType{\ECMV}}{\TMV}
  }{MAInconsistentTypes}

  \judgment{
    \ctxSynType{\ctx}{\ECMV}{\TMV'} \\
    \consistent{\TMV}{\TMV'}
  }{
    \ctxAnaType{\ctx}{\ECMV}{\TMV}
  }{MASubsume}
\end{mathpar}

\subsubsection{Alternative Rules}
[MSAp2] handles the case that the expression applied in function application does not synthesize a
type that is a matched arrow type. Treating the expression in that position to be in a
``constrained'' synthetic mode, we mark a type inconsistency around it.

As an alternative to overloading the meaning of type inconsistency errors, we may instead designate
a special error case for such applications:
%
\[\begin{array}{rrcl}
  \ECMName & \ECMV & \Coloneqq & \cdots \mid \ECNonMatchedAp{\ECMV}{\ECMV}
\end{array}\]
%
This gives rise to similar marking and typing judgments (the premises of each are identical):
%
\begin{mathpar}
  \judgment{
    \ctxSynFixedInto{\ctx}{\EMV_1}{\ECMV_1}{\TMV} \\
    \notMatchedArrow{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaFixedInto{\ctx}{\EMV_2}{\ECMV_2}{\TUnknown}
  }{
    \ctxSynFixedInto{\ctx}{\EAp{\EMV_1}{\EMV_2}}{\ECNonMatchedAp{\ECMV_1}{\ECMV_2}}{\TUnknown}
  }{FSAp2'}

  \judgment{
    \ctxSynType{\ctx}{\ECMV_1}{\TMV} \\
    \notMatchedArrow{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaType{\ctx}{\ECMV_2}{\TUnknown}
  }{
    \ctxSynType{\ctx}{\ECNonMatchedAp{\ECMV}{\ECMV}}{\TUnknown}
  }{MSAp2'}
\end{mathpar}

Another alternative is to still insert the hole around the applied expression without overloading
type inconsistency errors, instead designating a ``unmatched type`` error:
%
\[\begin{array}{rrcl}
  \ECMName & \ECMV & \Coloneqq & \cdots \mid \ECInconMatchedArrow{\ECMV}
\end{array}\]
%
The rules remain much the same (the premises are again identical):
%
\begin{mathpar}
  \judgment{
    \ctxSynFixedInto{\ctx}{\EMV_1}{\ECMV_1}{\TMV} \\
    \notMatchedArrow{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaFixedInto{\ctx}{\EMV_2}{\ECMV_2}{\TUnknown}
  }{
    \ctxSynFixedInto{\ctx}{\EAp{\EMV_1}{\EMV_2}}{\ECAp{\ECInconMatchedArrow{\ECMV_1}}{\ECMV_2}}{\TUnknown}
  }{FSAp2''}

  \judgment{
    \ctxSynType{\ctx}{\ECMV_1}{\TMV} \\
    \notMatchedArrow{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaType{\ctx}{\ECMV_2}{\TUnknown}
  }{
    \ctxSynType{\ctx}{\ECAp{\ECInconMatchedArrow{\ECMV}}{\ECMV}}{\TUnknown}
  }{MSAp2''}
\end{mathpar}

It then becomes natural to extend this to other elimination forms that require handling of unmatched
types, e.g. pairs:
%
\[\begin{array}{rrcl}
  \TMName  & \TMV  & \Coloneqq & \cdots \mid \TPair{\TMV}{\TMV} \\
  \EMName  & \EMV  & \Coloneqq & \cdots
                               \mid \EPair{\EMV}{\EMV} 
                               \mid \EProjL{\EMV} \mid \EProjR{\EMV} \\
  \ECMName & \ECMV & \Coloneqq & \cdots 
                               \mid \ECPair{\ECMV}{\ECMV} 
                               \mid \ECProjL{\ECMV} \mid \ECProjR{\ECMV}
                               \mid \ECInconMatchedPair{\ECMV}
\end{array}\]

\begin{mathpar}
  \judgment{
    \ctxSynType{\ctx}{\ECMV_1}{\TMV_1} \\
    \ctxSynType{\ctx}{\ECMV_2}{\TMV_2}
  }{
    \ctxSynType{\ctx}{\ECPair{\ECMV_1}{\ECMV_2}}{\TPair{\TMV_1}{\TMV_2}}
  }{MSPair}

  \judgment{
    \matchedPair{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaType{\ctx}{\ECMV_1}{\TMV_1} \\
    \ctxAnaType{\ctx}{\ECMV_2}{\TMV_2}
  }{
    \ctxAnaType{\ctx}{\ECPair{\ECMV_1}{\ECMV_2}}{\TMV}
  }{MAPair}

  \judgment{
    \ctxSynType{\ctx}{\ECMV}{\TMV} \\
    \matchedPair{\TMV}{\TMV_1}{\TVM_2}
  }{
    \ctxSynType{\ctx}{\ECProjL{\ECMV}}{\TMV_1}
  }{MSProjL1}

  \judgment{
    \ctxSynType{\ctx}{\ECMV}{\TMV} \\
    \notMatchedPair{\TMV}{\TMV_1}{\TVM_2}
  }{
    \ctxSynType{\ctx}{\ECProjL{\ECInconMatchedPair{\ECMV}}}{\TUnknown}
  }{MSProjL2}

  \judgment{
    \ctxSynType{\ctx}{\ECMV}{\TMV} \\
    \matchedPair{\TMV}{\TMV_1}{\TVM_2}
  }{
    \ctxSynType{\ctx}{\ECProjR{\ECMV}}{\TMV_2}
  }{MSProjR1}

  \judgment{
    \ctxSynType{\ctx}{\ECMV}{\TMV} \\
    \notMatchedPair{\TMV}{\TMV_1}{\TVM_2}
  }{
    \ctxSynType{\ctx}{\ECProjR{\ECInconMatchedPair{\ECMV}}}{\TUnknown}
  }{MSProjR2}
\end{mathpar}

\subsection{Hole Erasure}
$\judgbox{\erasesTo{\ECMV}{\EMV}}$ is a metafunction defined as follows:
%
\newcommand{\erasesToRow}[2]{\erase{#1} & = & #2}
\[\begin{array}{rcl}
  \erasesToRow{\ECEHole}{\EEHole} \\
  \erasesToRow{x}{x} \\
  \erasesToRow{(\ECLam{x}{\TMV}{\ECMV})}{\ELam{x}{\TMV}{(\erase{\ECMV})}} \\
  \erasesToRow{(\ECAp{\ECMV_1}{\ECMV_2})}{\EAp{(\erase{\ECMV_1})}{(\erase{\ECMV_2})}} \\
  \erasesToRow{\ECIntMV}{\EIntMV} \\
  \erasesToRow{(\ECPlus{\ECMV_1}{\ECMV_2})}{\EPlus{(\erase{\ECMV_1})}{(\erase{\ECMV_2})}} \\
  \erasesToRow{\ECTrue}{\ETrue} \\
  \erasesToRow{\ECFalse}{\EFalse} \\
  \erasesToRow{(\ECIf{\ECMV_1}{\ECMV_2}{\ECMV_3})}{\EIf{(\erase{\ECMV_1})}{(\erase{\ECMV_2})}{(\erase{\ECMV_3})}} \\
  \erasesToRow{\ECUnbound{x}}{x} \\
  \erasesToRow{\ECInconType{\ECMV}}{\erase{\ECMV}} \\
  \erasesToRow{\ECInconBr{\ECMV_1}{\ECMV_2}{\ECMV_3}}{\EIf{(\erase{\ECMV_1})}{(\erase{\ECMV_2})}{(\erase{\ECMV_3})}} \\
\end{array}\]

\subsection{Metatheorems}
\begin{theorem}[name=Hole Insertion] \
  \begin{enumerate}[label=(\arabic*)]
    \item If $\ctxSynFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}$, then $\ctxSynType{\ctx}{\ECMV}{\TMV}$ and
      $\erasesTo{\ECMV}{\EMV}$. 
    \item If $\ctxAnaFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}$, then $\ctxAnaType{\ctx}{\ECMV}{\TMV}$ and
      $\erasesTo{\ECMV}{\EMV}$.
  \end{enumerate}
\end{theorem}

\begin{theorem}[name=Totality] \
  \begin{enumerate}[label=(\arabic*)]
    \item For all $\ctx$ and $\EMV$, there exist $\ECMV$ and $\TMV$ such that
      $\ctxSynFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}$. 
    \item For all $\ctx$, $\EMV$, and $\TMV$, there exists $\ECMV$ such that
      $\ctxAnaFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}$.
  \end{enumerate}
\end{theorem}

\begin{theorem}[name=Unicity] \
  \begin{enumerate}[label=(\arabic*)]
    \item If $\ctxSynFixedInto{\ctx}{\EMV}{\ECMV_1}{\TMV_1}$ and
      $\ctxSynFixedInto{\ctx}{\EMV}{\ECMV_2}{\TMV_2}$, then $\ECMV_1 = \ECMV_2$ and $\TMV_1 =
      \TMV_2$.
    \item If $\ctxAnaFixedInto{\ctx}{\EMV}{\ECMV_1}{\TMV_1}$ and
      $\ctxAnaFixedInto{\ctx}{\EMV}{\ECMV_2}{\TMV_2}$, then $\ECMV_1 = \ECMV_2$ and $\TMV_1 =
      \TMV_2$.
  \end{enumerate}
\end{theorem}


\end{document}
