\input{symbols/polymorphism}

\subsection{Extension: polymorphism}

\subsubsection{Syntax}
\[\begin{array}{rrcl}
  \TMName  & \TMV  & \Coloneqq & \cdots \mid \TForall{\TVarMV}{\TMV} \mid \TVarMV \\
  \MTMName & \MTMV & \Coloneqq & \cdots
                     % \MTUnknown \mid \MTNum \mid \MTBool
                     % \mid \MTArrow{\MTMV}{\MTMV} \mid \MTProd{\MTMV}{\MTMV}
                     \mid \MTForall{\MTVarMV}{\MTMV} \mid \MTVarMV \mid \MTUnbound{\MTVarMV} \\
  \EMName  & \EMV  & \Coloneqq & \cdots \mid \ETypeLam{\TVarMV}{\EMV} \mid \ETypeAp{\EMV}{\TMV} \\
  \ECMName & \ECMV & \Coloneqq & \cdots \mid \ECTypeLam{\MTVarMV}{\ECMV} \mid \ECTypeAp{\ECMV}{\MTMV} \\
           &       & \mid      & \ECSynNonMatchedForall{\ECMV} \mid \ECAnaNonMatchedForall{\ECMV}
\end{array}\]

\subsubsection{Unmarked types}
\judgbox{\ensuremath{\tvarCtxConsistentU{\tvarCtx}{\TMV_1}{\TMV_2}}} $\TMV_1$ and $\TMV_2$ are consistent
%
\begin{mathpar}
  \cdots

  \inferrule[TCForall]{
    \tvarCtxConsistentU{\extendTvarCtx{\tvarCtx}{\TVarMV}}{\TMV}{\TMV'}
  }{
    \tvarCtxConsistentU{\tvarCtx}{\TForall{\TVarMV}{\TMV}}{\TForall{\TVarMV}{\TMV'}}
  }

  \inferrule[TCVar]{
    \inTvarCtx{\tvarCtx}{\TVarMV}
  }{
    \tvarCtxConsistentU{\tvarCtx}{\TVarMV}{\TVarMV}
  }
\end{mathpar}

\judgbox{\ensuremath{\tvarCtxWFU{\tvarCtx}{\TMV}}} $\TMV$ is well-formed
%
\begin{mathpar}
  \inferrule[TWFUnknown]{ }{
    \tvarCtxWFU{\tvarCtx}{\MTUnknown}
  }

  \inferrule[TWFNum]{ }{
    \tvarCtxWFU{\tvarCtx}{\MTNum}
  }

  \inferrule[TWFBool]{ }{
    \tvarCtxWFU{\tvarCtx}{\MTBool}
  }

  \inferrule[TWFArr]{
    \tvarCtxWFU{\tvarCtx}{\MTMV_1} \\
    \tvarCtxWFU{\tvarCtx}{\MTMV_2}
  }{
    \tvarCtxWFU{\tvarCtx}{\TArrow{\MTMV_1}{\MTMV_2}}
  }

  \inferrule[TWFProd]{
    \tvarCtxWFU{\tvarCtx}{\MTMV_1} \\
    \tvarCtxWFU{\tvarCtx}{\MTMV_2}
  }{
    \tvarCtxWFU{\tvarCtx}{\TProd{\MTMV_1}{\MTMV_2}}
  }

  \inferrule[TWFForall]{
    \tvarCtxWFU{\extendTvarCtx{\tvarCtx}{\MTVarMV}}{\MTMV}
  }{
    \tvarCtxWFU{\tvarCtx}{\MTForall{\MTVarMV}{\MTMV}}
  }

  \inferrule[TWFVar]{
    \inTvarCtx{\tvarCtx}{\MTVarMV}
  }{
    \tvarCtxWFU{\tvarCtx}{\MTVarMV}
  }
\end{mathpar}

\judgbox{\ensuremath{\matchedForall{\TMV}{\TVarMV}{\TMV'}}} $\TMV$ has matched forall type $\TForall{\TVarMV}{\TMV'}$
%
\begin{mathpar}
  \inferrule[TMFUnknown]{ }{
    \matchedForall{\TUnknown}{\TVarMV}{\TUnknown}
  }

  \inferrule[TMFForall]{ }{
    \matchedForall{\TForall{\TVarMV}{\TMV}}{\TVarMV}{\TMV}
  }
\end{mathpar}

\subsubsection{Type marking}
\judgbox{\ensuremath{\tvarCtxTypeMarkedInto{\tvarCtx}{\TMV}{\MTMV}}} $\TMV$ is marked into $\MTMV$
%
\begin{mathpar}
  \inferrule[MKTUnknown]{ }{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TUnknown}{\MTUnknown}
  }

  \inferrule[MKTNum]{ }{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TNum}{\MTNum}
  }

  \inferrule[MKTBool]{ }{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TBool}{\MTBool}
  }

  \inferrule[MKTArr]{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TMV_1}{\MTMV_1} \\
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TMV_2}{\MTMV_2}
  }{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TArrow{\TMV_1}{\TMV_2}}{\MTArrow{\MTMV_1}{\MTMV_2}}
  }

  \inferrule[MKTProd]{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TMV_1}{\MTMV_1} \\
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TMV_2}{\MTMV_2}
  }{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TProd{\TMV_1}{\TMV_2}}{\MTProd{\MTMV_1}{\MTMV_2}}
  }

  \inferrule[MKTForall]{
    \tvarCtxTypeMarkedInto{\extendTvarCtx{\tvarCtx}{\TVarMV}}{\TMV}{\MTMV}
  }{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TForall{\TVarMV}{\TMV}}{\MTForall{\MTVarMV}{\MTMV}}
  }

  \inferrule[MKTVar]{
    \inTvarCtx{\tvarCtx}{\TVarMV}
  }{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TVarMV}{\MTVarMV}
  }

  \inferrule[MKTUnbound]{
    \notInTvarCtx{\tvarCtx}{\TVarMV}
  }{
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TVarMV}{\MTUnbound{\MTVarMV}}
  }
\end{mathpar}

\subsubsection{Marked types}
\judgbox{\ensuremath{\tvarCtxConsistentM{\tvarCtx}{\MTMV_1}{\MTMV_2}}} $\MTMV_1$ and $\MTMV_2$ are consistent
%
\begin{mathpar}
  \cdots

  \inferrule[MTCForall]{
    \tvarCtxConsistentM{\extendTvarCtx{\tvarCtx}{\MTVarMV}}{\MTMV}{\MTMV'}
  }{
    \tvarCtxConsistentM{\tvarCtx}{\TForall{\MTVarMV}{\MTMV}}{\TForall{\MTVarMV}{\MTMV'}}
  }

  \inferrule[MTCVar]{
    \inTvarCtx{\tvarCtx}{\MTVarMV}
  }{
    \tvarCtxConsistentM{\tvarCtx}{\MTVarMV}{\MTVarMV}
  }

  \inferrule[MTCUnbound1]{
    \notInTvarCtx{\tvarCtx}{\MTVarMV}
  }{
    \tvarCtxConsistentM{\tvarCtx}{\MTUnbound{\MTVarMV}}{\MTMV}
  }

  \inferrule[MTCUnbound2]{
    \notInTvarCtx{\tvarCtx}{\MTVarMV}
  }{
    \tvarCtxConsistentM{\tvarCtx}{\MTMV}{\MTUnbound{\MTVarMV}}
  }
\end{mathpar}

\judgbox{\ensuremath{\tvarCtxWFM{\tvarCtx}{\MTMV}}} $\MTMV$ is well-formed
%
\begin{mathpar}
  \inferrule[MTWFUnknown]{ }{
    \tvarCtxWFM{\tvarCtx}{\TUnknown}
  }

  \inferrule[MTWFNum]{ }{
    \tvarCtxWFM{\tvarCtx}{\TNum}
  }

  \inferrule[MTWFBool]{ }{
    \tvarCtxWFM{\tvarCtx}{\TBool}
  }

  \inferrule[MTWFArr]{
    \tvarCtxWFM{\tvarCtx}{\MTMV_1} \\
    \tvarCtxWFM{\tvarCtx}{\MTMV_2}
  }{
    \tvarCtxWFM{\tvarCtx}{\TArrow{\MTMV_1}{\MTMV_2}}
  }

  \inferrule[MTWFProd]{
    \tvarCtxWFM{\tvarCtx}{\MTMV_1} \\
    \tvarCtxWFM{\tvarCtx}{\MTMV_2}
  }{
    \tvarCtxWFM{\tvarCtx}{\TProd{\MTMV_1}{\MTMV_2}}
  }

  \inferrule[MTWFForall]{
    \tvarCtxWFM{\extendTvarCtx{\tvarCtx}{\MTVarMV}}{\MTMV}
  }{
    \tvarCtxWFM{\tvarCtx}{\TForall{\MTVarMV}{\MTMV}}
  }

  \inferrule[MTWFVar]{
    \inTvarCtx{\tvarCtx}{\MTVarMV}
  }{
    \tvarCtxWFM{\tvarCtx}{\MTVarMV}
  }

  \inferrule[MTWFUnbound]{
    \notInTvarCtx{\tvarCtx}{\MTVarMV}
  }{
    \tvarCtxWFM{\tvarCtx}{\MTUnbound{\MTVarMV}}
  }
\end{mathpar}

\judgbox{\ensuremath{\matchedForall{\MTMV}{\MTVarMV}{\MTMV'}}} $\MTMV$ has matched forall type $\MTForall{\MTVarMV}{\MTMV'}$
%
\begin{mathpar}
  \inferrule[MTMFUnknown]{ }{
    \matchedForall{\MTUnknown}{\MTVarMV}{\MTUnknown}
  }

  \inferrule[MTMFForall]{ }{
    \matchedForall{\MTForall{\MTVarMV}{\MTMV}}{\MTVarMV}{\MTMV}
  }

  \inferrule[MTMFUnbound]{ }{
    \matchedForall{\MTUnbound{\MTVarMV}}{\MTVarMV}{\MTUnknown}
  }
\end{mathpar}

\subsubsection{Unmarked expressions}
\judgbox{\ensuremath{\bothCtxSynTypeU{\tvarCtx}{\ctx}{\EMV}{\TMV}}} $\EMV$ synthesizes type $\TMV$
%
\begin{mathpar}
  \cdots

  \inferrule[USTypeLam]{
    \bothCtxSynTypeU{\extendTvarCtx{\tvarCtx}{\TVarMV}}{\ctx}{\EMV}{\TMV}
  }{
    \bothCtxSynTypeU{\tvarCtx}{\ctx}{\ETypeLam{\TVarMV}{\EMV}}{\TForall{\TVarMV}{\TMV}}
  }

  \inferrule[USTypeAp]{
    \bothCtxSynTypeU{\tvarCtx}{\ctx}{\EMV}{\TMV} \\
    \tvarCtxWFU{\tvarCtx}{\TMV_2} \\
    \matchedForall{\TMV}{\TVarMV}{\TMV_1}
  }{
    \bothCtxSynTypeU{\tvarCtx}{\ctx}{\ETypeAp{\EMV}{\TMV_2}}{\subst{\TMV_1}{\TMV_2}{\TVarMV}}
  }
\end{mathpar}

\judgbox{\ensuremath{\bothCtxAnaTypeU{\tvarCtx}{\ctx}{\EMV}{\TMV}}} $\EMV$ analyzes against type $\TMV$
%
\begin{mathpar}
  \cdots

  \inferrule[UATypeLam]{
    \matchedForall{\TMV}{\TVarMV}{\TMV'} \\
    \bothCtxAnaTypeU{\extendTvarCtx{\tvarCtx}{\TVarMV}}{\ctx}{\EMV}{\TMV'}
  }{
    \bothCtxAnaTypeU{\tvarCtx}{\ctx}{\ETypeLam{\TVarMV}{\EMV}}{\TMV}
  }
\end{mathpar}

\judgbox{\ensuremath{\subsumable{\EMV}}} $\EMV$ is subsumable
%
\begin{mathpar}
  \cdots

  \inferrule[USuTypeAp]{ }{
    \subsumable{\ETypeAp{\EMV}{\TMV}}
  }
\end{mathpar}

\subsubsection{Marking}
\judgbox{\bothCtxSynFixedInto{\tvarCtx}{\ctx}{\EMV}{\ECMV}{\MTMV}} $\EMV$ is marked into $\ECMV$ and synthesizes type $\MTMV$
%
\begin{mathpar}
  \cdots

  \inferrule[MKSTypeLam]{
    \bothCtxSynFixedInto{\extendTvarCtx{\tvarCtx}{\TVarMV}}{\ctx}{\EMV}{\ECMV}{\MTMV}
  }{
    \bothCtxSynFixedInto{\tvarCtx}{\ctx}{\ETypeLam{\TVarMV}{\EMV}}{\ECTypeLam{\MTVarMV}{\ECMV}}{\MTForall{\MTVarMV}{\MTMV}}
  }

  \inferrule[MKSTypeAp1]{
    \bothCtxSynFixedInto{\tvarCtx}{\ctx}{\EMV}{\ECMV}{\MTMV} \\
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TMV_2}{\MTMV_2} \\
    \matchedForall{\MTMV}{\MTVarMV}{\MTMV_1}
  }{
    \bothCtxSynFixedInto{\tvarCtx}{\ctx}{\ETypeAp{\EMV}{\TMV_2}}{\ECTypeAp{\ECMV}{\MTMV_2}}{\subst{\MTMV_1}{\MTMV_2}{\MTVarMV}}
  }

  \inferrule[MKSTypeAp2]{
    \bothCtxSynFixedInto{\tvarCtx}{\ctx}{\EMV}{\ECMV}{\MTMV} \\
    \tvarCtxTypeMarkedInto{\tvarCtx}{\TMV_2}{\MTMV_2} \\
    \notMatchedForall{\MTMV}
  }{
    \bothCtxSynFixedInto{\tvarCtx}{\ctx}{\ETypeAp{\EMV}{\TMV_2}}{\ECTypeAp{\ECMV}{\MTMV_2}}{\MTUnknown}
  }
\end{mathpar}

\judgbox{\bothCtxAnaFixedInto{\tvarCtx}{\ctx}{\EMV}{\ECMV}{\MTMV}} $\EMV$ is marked into $\ECMV$ and analyzes against type $\MTMV$
%
\begin{mathpar}
  \cdots

  \inferrule[MKATypeLam1]{
    \matchedForall{\MTMV}{\MTVarMV}{\MTMV'} \\
    \bothCtxAnaFixedInto{\extendTvarCtx{\tvarCtx}{\MTVarMV}}{\ctx}{\EMV}{\ECMV}{\MTMV'}
  }{
    \bothCtxAnaFixedInto{\tvarCtx}{\ctx}{\ETypeLam{\TVarMV}{\EMV}}{\ECTypeLam{\MTVarMV}{\ECMV}}{\MTMV}
  }

  \inferrule[MKATypeLam2]{
    \notMatchedForall{\MTMV} \\
    \bothCtxAnaFixedInto{\extendTvarCtx{\tvarCtx}{\MTVarMV}}{\ctx}{\EMV}{\ECMV}{\MTUnknown}
  }{
    \bothCtxAnaFixedInto{\tvarCtx}{\ctx}{\ETypeLam{\TVarMV}{\EMV}}{\ECTypeLamAnaNonMatchedForall{\MTVarMV}{\ECMV}}{\MTMV}
  }
\end{mathpar}

\subsubsection{Marked expressions}
\judgbox{\ensuremath{\bothCtxSynTypeM{\tvarCtx}{\ctx}{\EMV}{\TMV}}} $\EMV$ synthesizes type $\TMV$
%
\begin{mathpar}
  \cdots

  \inferrule[MSTypeLam]{
    \bothCtxSynTypeM{\extendTvarCtx{\tvarCtx}{\MTVarMV}}{\ctx}{\ECMV}{\MTMV}
  }{
    \bothCtxSynTypeM{\tvarCtx}{\ctx}{\ECTypeLam{\MTVarMV}{\ECMV}}{\MTForall{\MTVarMV}{\MTMV}}
  }

  \inferrule[MSTypeAp1]{
    \bothCtxSynTypeM{\tvarCtx}{\ctx}{\ECMV}{\MTMV} \\
    \tvarCtxWFM{\tvarCtx}{\MTMV_2} \\
    \matchedForall{\MTMV}{\MTVarMV}{\MTMV_1}
  }{
    \bothCtxSynTypeM{\tvarCtx}{\ctx}{\ECTypeAp{\ECMV}{\MTMV_2}}{\subst{\MTMV_1}{\MTMV_2}{\MTVarMV}}
  }

  \inferrule[MSTypeAp2]{
    \bothCtxSynTypeM{\tvarCtx}{\ctx}{\ECMV}{\MTMV} \\
    \tvarCtxWFM{\tvarCtx}{\MTMV_2} \\
    \notMatchedForall{\MTMV}
  }{
    \bothCtxSynTypeM{\tvarCtx}{\ctx}{\ECTypeApSynNonMatchedForall{\ECMV}{\MTMV_2}}{\MTUnknown}
  }
\end{mathpar}

\judgbox{\ensuremath{\bothCtxAnaTypeM{\tvarCtx}{\ctx}{\ECMV}{\MTMV}}} $\ECMV$ analyzes against type $\MTMV$
%
\begin{mathpar}
  \cdots

  \inferrule[MATypeLam1]{
    \matchedForall{\MTMV}{\MTVarMV}{\MTMV'} \\
    \bothCtxAnaTypeM{\extendTvarCtx{\tvarCtx}{\MTVarMV}}{\ctx}{\ECMV}{\MTMV'}
  }{
    \bothCtxAnaTypeM{\tvarCtx}{\ctx}{\ECTypeLam{\MTVarMV}{\ECMV}}{\MTMV}
  }

  \inferrule[MATypeLam2]{
    \notMatchedForall{\MTMV} \\
    \bothCtxAnaTypeM{\extendTvarCtx{\tvarCtx}{\MTVarMV}}{\ctx}{\ECMV}{\MTUnknown}
  }{
    \bothCtxAnaTypeM{\tvarCtx}{\ctx}{\ECTypeLamAnaNonMatchedForall{\MTVarMV}{\ECMV}}{\MTMV}
  }
\end{mathpar}

\judgbox{\ensuremath{\subsumable{\ECMV}}} $\ECMV$ is subsumable
%
\begin{mathpar}
  \cdots

  \inferrule[MSuTypeAp1]{ }{
    \subsumable{\ECTypeAp{\ECMV}{\MTMV}}
  }

  \inferrule[MSuTypeAp2]{ }{
    \subsumable{\ECTypeApSynNonMatchedForall{\ECMV}{\MTMV}}
  }
\end{mathpar}
