\subsection{Extension: patterned let expressions}
\subsubsection{Syntax}
\[\begin{array}{rrcl}
  \TMName  & \TMV  & \Coloneqq & \cdots \mid \TUnknownSwitch \\
  \EMName  & \EMV  & \Coloneqq & \cdots \mid \ELet{\PMV}{\EMV}{\EMV} \\
  \ECMName & \ECMV & \Coloneqq & \cdots \mid \ECLet{\PMV}{\ECMV}{\ECMV} \\
  \PMName  & \PMV  & \Coloneqq & \PWild \mid \PVar{x} \mid \PPair{\PMV}{\PMV} \mid \PAsc{\PMV}{\TMV} \\
  \PCMName & \PCMV & \Coloneqq & \PCWild \mid \PCVar{x} \mid \PCPair{\PCMV}{\PCMV} \mid \PCAsc{\PCMV}{\TMV}
                               \mid \PCInconType{\PCMV} \mid \PCAnaNonMatchedProd{\PCMV}
\end{array}\]

\subsubsection{Unmarked expressions}
\judgbox{\ctxSynTypeU{\ctx}{\EMV}{\TMV}} $\EMV$ synthesizes type $\TMV$
%
\begin{mathpar}
  \inferrule[USLetPat]{
    \ctxSynPatU{\ctx}{\PMV}{\TMV_p} \\
    \ctxAnaTypeU{\ctx}{\EMV_{1}}{\TMV_p} \\
    \ctxSynTypeU{\ctx}{\EMV_{1}}{\TMV_{1}} \\\\
    \ctxAnaPatU{\ctx}{\PMV}{\TMV_{1}}{\ctx'} \\
    \ctxSynTypeU{\ctx'}{\EMV_{2}}{\TMV_2}
  }{
    \ctxSynTypeU{\ctx}{\ELet{\PMV}{\EMV_{1}}{\EMV_{2}}}{\TMV_2}
  }
\end{mathpar}

\judgbox{\ctxAnaTypeU{\ctx}{\EMV}{\TMV}} $\EMV$ analyzes against type $\TMV$
%
\begin{mathpar}
  \inferrule[UASynSwitch]{
    \ctxSynTypeU{\ctx}{\EMV}{\ctx'}
  }{
    \ctxAnaTypeU{\ctx}{\EMV}{\TUnknownSwitch}
  }

  \inferrule[UALetPat]{
    \ctxSynPatU{\ctx}{\PMV}{\TMV_p} \\
    \ctxAnaTypeU{\ctx}{\EMV_{1}}{\TMV_p} \\
    \ctxSynTypeU{\ctx}{\EMV_{1}}{\TMV_{1}} \\\\
    \ctxAnaPatU{\ctx}{\PMV}{\TMV_{1}}{\ctx'} \\
    \ctxAnaTypeU{\ctx'}{\EMV_{2}}{\TMV_2}
  }{
    \ctxAnaTypeU{\ctx}{\ELet{\PMV}{\EMV_{1}}{\EMV_{2}}}{\TMV_2}
  }
\end{mathpar}

\subsubsection{Marking}
\judgbox{\ctxSynFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}} $\EMV$ is marked into $\ECMV$ and synthesizes type $\TMV$
%
\begin{mathpar}
  \inferrule[ISLetPat]{
    \ctxSynFixedInto{\ctx}{\PMV}{\PCMV}{\TMV_p} \\
    \ctxAnaFixedInto{\ctx}{\EMV_{1}}{\ECMV_{1}}{\TMV_{p}} \\\\
    \ctxSynTypeU{\ctx}{\EMV_{1}}{\TMV_{1}} \\
    \ctxAnaPatU{\ctx}{\PMV}{\TMV_{1}}{\ctx'} \\
    \ctxSynFixedInto{\ctx'}{\EMV_{2}}{\ECMV_{2}}{\TMV_2}
  }{
    \ctxSynFixedInto{\ctx}{\ELet{\PMV}{\EMV_{1}}{\EMV_{2}}}{\ELet{\PCMV}{\ECMV_{1}}{\ECMV_{2}}}{\TMV_2}
  }
\end{mathpar} \\

\judgbox{\ctxAnaFixedInto{\ctx}{\EMV}{\ECMV}{\TMV}} $\EMV$ is marked into $\ECMV$ and analyzes against type $\TMV$
%
\begin{mathpar}
  \inferrule[IALetPat]{
    \ctxSynFixedInto{\ctx}{\PMV}{\PCMV}{\TMV_p} \\
    \ctxAnaFixedInto{\ctx}{\EMV_{1}}{\ECMV_{1}}{\TMV_{p}} \\\\
    \ctxSynTypeU{\ctx}{\EMV_{1}}{\TMV_{1}} \\
    \ctxAnaPatU{\ctx}{\PMV}{\TMV_{1}}{\ctx'} \\
    \ctxAnaFixedInto{\ctx'}{\EMV_{2}}{\ECMV_{2}}{\TMV_2}
  }{
    \ctxAnaFixedInto{\ctx}{\ELet{\PMV}{\EMV_{1}}{\EMV_{2}}}{\ELet{\PCMV}{\ECMV_{1}}{\ECMV_{2}}}{\TMV_2}
  }
\end{mathpar}

\subsubsection{Marked expressions}
\judgbox{\ctxSynTypeM{\ctx}{\ECMV}{\TMV}} $\ECMV$ synthesizes type $\TMV$
%
\begin{mathpar}
  \inferrule[MSLetPat]{
    \ctxSynPatM{\ctx}{\PCMV}{\TMV_p} \\
    \ctxAnaTypeM{\ctx}{\ECMV_{1}}{\TMV_p} \\
    \ctxSynTypeM{\ctx}{\ECMV_{1}}{\TMV_{1}} \\\\
    \ctxAnaPatM{\ctx}{\PCMV}{\TMV_{1}}{\ctx'} \\
    \ctxSynTypeM{\ctx'}{\ECMV_{2}}{\TMV_2}
  }{
    \ctxSynTypeM{\ctx}{\ELet{\PCMV}{\ECMV_{1}}{\ECMV_{2}}}{\TMV_2}
  }
\end{mathpar}

\judgbox{\ctxAnaTypeM{\ctx}{\ECMV}{\TMV}} $\ECMV$ analyzes against type $\TMV$
%
\begin{mathpar}
  \inferrule[MALetPat]{
    \ctxSynPatM{\ctx}{\PCMV}{\TMV_p} \\
    \ctxAnaTypeM{\ctx}{\ECMV_{1}}{\TMV_p} \\
    \ctxSynTypeM{\ctx}{\ECMV_{1}}{\TMV_{1}} \\\\
    \ctxAnaPatM{\ctx}{\PCMV}{\TMV_{1}}{\ctx'} \\
    \ctxAnaTypeM{\ctx'}{\ECMV_{2}}{\TMV_2}
  }{
    \ctxAnaTypeM{\ctx}{\ELet{\PCMV}{\ECMV_{1}}{\ECMV_{2}}}{\TMV_2}
  }
\end{mathpar}

\subsubsection{Unmarked patterns}
\judgbox{\ensuremath{\ctxSynPatU{\ctx}{\PMV}{\TMV}}} $\PMV$ synthesizes type $\TMV$
%
\begin{mathpar}
  \inferrule[USPWild]{ }{
    \ctxSynPatU{\ctx}{\PWild}{\TUnknownSwitch}
  }
 
  \inferrule[USPVar]{ }{
    \ctxSynPatU{\ctx}{\PVar{x}}{\TUnknownSwitch}
  }

  \inferrule[USPPair]{
    \ctxSynPatU{\ctx}{\PMV_1}{\TMV_1} \\
    \ctxSynPatU{\ctx}{\PMV_2}{\TMV_2}
  }{
    \ctxSynPatU{\ctx}{\PPair{\PMV_1}{\PMV_2}}{\TProd{\TMV_1}{\TMV_2}}
  }
 
  \inferrule[USPAnn]{
    \ctxAnaPatU{\ctx}{\PMV}{\TMV}{\ctx'}
  }{
    \ctxSynPatU{\ctx}{\PAsc{\PMV}{\TMV}}{\TMV}
  }
\end{mathpar}

\judgbox{\ensuremath{\ctxAnaPatU{\ctx_1}{\PMV}{\TMV}{\ctx_2}}} $\PMV$ analyzes against type $\TMV$ producing context $\ctx_2$
%
\begin{mathpar}
  \inferrule[UAPWild]{ }{
    \ctxAnaPatU{\ctx}{\PWild}{\TMV}{\ctx}
  }
 
  \inferrule[UAPVar]{ }{
    \ctxAnaPatU{\ctx}{\PVar{x}}{\TMV}{\extendCtx{\ctx}{x}{\TMV}}
  }

  \inferrule[UAPPair]{
    \matchedProd{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaPatU{\ctx}{\PMV_1}{\TMV_1}{\ctx_1} \\
    \ctxAnaPatU{\ctx_1}{\PMV_2}{\TMV_2}{\ctx_2}
  }{
    \ctxAnaPatU{\ctx}{\PPair{\PMV_1}{\PMV_2}}{\TMV}{\ctx_2}
  }
 
  \inferrule[UAPAnn]{
    \ctxAnaPatU{\ctx}{\PMV}{\TMV'}{\ctx'} \\
    \consistent{\TMV}{\TMV'}
  }{
    \ctxAnaPatU{\ctx}{\PAsc{\PMV}{\TMV'}}{\TMV}{\ctx'}
  }
\end{mathpar}

\subsubsection{Pattern marking}
\judgbox{\ensuremath{\ctxSynFixedIntoPat{\ctx}{\PMV}{\PCMV}{\TMV}}} $\PMV$ is marked into $\PCMV$ and synthesizes $\TMV$
 %
\begin{mathpar}
  \inferrule[ISPWild]{ }{
    \ctxSynFixedIntoPat{\ctx}{\PWild}{\PCWild}{\TUnknownSwitch}
  }
   
  \inferrule[ISPVar]{ }{
    \ctxSynFixedIntoPat{\ctx}{\PVar{x}}{\PCVar{x}}{\TUnknownSwitch}
  }

  \inferrule[ISPPair]{
    \ctxSynFixedIntoPat{\ctx}{\PMV_1}{\PCMV_1}{\TMV_1} \\\\
    \ctxSynFixedIntoPat{\ctx}{\PMV_2}{\PCMV_2}{\TMV_2}
  }{
     \ctxSynFixedIntoPat{\ctx}{\EPair{\PMV_1}{\PMV_2}}{\ECPair{\PCMV_1}{\PCMV_2}}{\TProd{\TMV_1}{\TMV_2}}
  }

  \inferrule[ISPAnn1]{
    \ctxAnaPatU{\ctx}{\PMV{}}{\TMV}{\ctx'} \\
    \ctxAnaFixedIntoPat{\ctx}{\PMV}{\PCMV}{\TMV}{\ctx''}
  }{
    \ctxSynFixedIntoPat{\ctx}{\PAsc{\PMV}{\TMV}}{\PCAsc{\PCMV}{\TMV}}{\tau}
  }

  \inferrule[ISPAnn2]{
    \ctxNotAnaPatU{\ctx}{\PMV{}}{\TMV}{\ctx'} \\
    \ctxAnaFixedIntoPat{\ctx}{\PMV}{\PCMV}{\TUnknown}{\ctx''}
  }{
    \ctxSynFixedIntoPat{\ctx}{\PAsc{\PMV}{\TMV}}{\PCAsc{\PCInconType{\PCMV}}{\TMV}}{\TMV}
  }
\end{mathpar}

\judgbox{\ensuremath{\ctxAnaFixedIntoPat{\ctx_1}{\PMV}{\PCMV}{\TMV}{\ctx_2}}} $\PMV$ is marked into $\PCMV$ and analyzes against $\TMV$ producing $\ctx_2$
%
\begin{mathpar}
  \inferrule[IAPWild]{ }{
    \ctxAnaFixedIntoPat{\ctx}{\PWild}{\PCWild}{\TMV}{\ctx}
  }
   
  \inferrule[IAPVar]{ }{
    \ctxAnaFixedIntoPat{\ctx}{\PVar{x}}{\PCVar{x}}{\TMV}{\extendCtx{\ctx}{x}{\TMV}}
  }

  \inferrule[IAPPair1]{
    \matchedProd{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaFixedIntoPat{\ctx}{\PMV_1}{\PCMV_1}{\TMV_1}{\ctx_1} \\\\
    \ctxAnaFixedIntoPat{\ctx_1}{\PMV_2}{\PCMV_2}{\TMV_2}{\ctx_2}
  }{
    \ctxAnaFixedIntoPat{\ctx}{\PPair{\PMV_1}{\PMV_2}}{\PCPair{\PCMV_1}{\PCMV_2}}{\TMV}{\ctx_2}
  }

  \inferrule[IAPPair2]{
    \notMatchedProd{\TMV} \\
    \ctxAnaFixedIntoPat{\ctx}{\PMV_1}{\PCMV_1}{\TUnknown}{\ctx_1} \\\\
    \ctxAnaFixedIntoPat{\ctx_1}{\PMV_2}{\PCMV_2}{\TUnknown}{\ctx_2}
  }{
    \ctxAnaFixedIntoPat{\ctx}{\PPair{\PMV_1}{\PMV_2}}{\PCAnaNonMatchedProd{\PCPair{\PCMV_1}{\PCMV_2}}}{\TMV}{\ctx_2}
  }

  \inferrule[IAPAnn1]{
    \consistent{\TMV}{\TMV'} \\
    \ctxAnaFixedIntoPat{\ctx}{\PMV}{\PCMV}{\TMV'}{\ctx'}
  }{
    \ctxAnaFixedIntoPat{\ctx}{\PAsc{\PMV}{\TMV'}}{\PCAsc{\PCMV}{\TMV'}}{\TMV}{\ctx'}
  }

  \inferrule[IAPAnn2]{
    \inconsistent{\TMV}{\TMV'} \\
    \ctxAnaFixedIntoPat{\ctx}{\PMV}{\PCMV}{\TMV'}{\ctx'}
  }{
    \ctxAnaFixedIntoPat{\ctx}{\PAsc{\PMV}{\TMV'}}{\PCInconType{\PCAsc{\PCMV}{\TMV'}}}{\TMV}{\ctx'}
  }
\end{mathpar}

\subsubsection{Marked patterns}
\judgbox{\ensuremath{\ctxSynPatM{\ctx}{\PCMV}{\TMV}}} $\PCMV$ synthesizes type $\TMV$
%
\begin{mathpar}
  \inferrule[MSPWild]{ }{
    \ctxSynPatM{\ctx}{\PCWild}{\TUnknownSwitch}
  }

  \inferrule[MSPVar]{ }{
    \ctxSynPatM{\ctx}{\PCVar{x}}{\TUnknownSwitch}
  }

  \inferrule[MSPPair]{
    \ctxSynPatM{\ctx}{\PCMV_1}{\TMV_1} \\
    \ctxSynPatM{\ctx}{\PCMV_2}{\TMV_2}
  }{
    \ctxSynPatM{\ctx}{\PCPair{\PCMV_1}{\PCMV_2}}{\TProd{\TMV_1}{\TMV_2}}
  }

  \inferrule[MSPAnn]{
    \ctxAnaPatM{\ctx}{\PCMV}{\TMV}{\ctx'}
  }{
    \ctxSynPatM{\ctx}{\PCAsc{\PCMV}{\TMV}}{\TMV}
  }
\end{mathpar}

\judgbox{\ensuremath{\ctxAnaPatM{\ctx_1}{\PCMV}{\TMV}{\ctx_2}}} $\PCMV$ analyzes against type $\TMV$ producing context $\ctx_2$
%
\begin{mathpar}
  \inferrule[MAPWild]{ }{
    \ctxAnaPatM{\ctx}{\PCWild}{\TMV}{\ctx}
  }
   
  \inferrule[MAPVar]{ }{
    \ctxAnaPatM{\ctx}{\PCVar{x}}{\TMV}{\extendCtx{\ctx}{x}{\TMV}}
  }

  \inferrule[MAPPair1]{
    \matchedProd{\TMV}{\TMV_1}{\TMV_2} \\
    \ctxAnaPatM{\ctx}{\PCMV_1}{\TMV_1}{\ctx_1} \\\\
    \ctxAnaPatM{\ctx_1}{\PCMV_2}{\TMV_2}{\ctx_2}
  }{
    \ctxAnaPatM{\ctx}{\PCPair{\PCMV_1}{\PCMV_2}}{\TMV}{\ctx_2}
  }

  \inferrule[MAPPair2]{
    \notMatchedProd{\TMV} \\
    \ctxAnaPatM{\ctx}{\PCMV_1}{\TUnknown}{\ctx_1} \\\\
    \ctxAnaPatM{\ctx_1}{\PCMV_2}{\TUnknown}{\ctx_2}
  }{
    \ctxAnaPatM{\ctx}{\PCAnaNonMatchedProd{\PCPair{\PCMV_1}{\PCMV_2}}}{\TMV}{\ctx_2}
  }

  \inferrule[MAPAnn1]{
    \consistent{\TMV}{\TMV'} \\
    \ctxAnaPatM{\ctx}{\PCMV}{\TMV'}{\ctx'}
  }{
    \ctxAnaPatM{\ctx}{\PCAsc{\PCMV}{\TMV'}}{\TMV}{\ctx'}
  }

  \inferrule[MAPAnn2]{
    \inconsistent{\TMV}{\TMV'} \\
    \ctxAnaPatM{\ctx}{\PCMV}{\TMV'}{\ctx'}
  }{
    \ctxAnaPatM{\ctx}{\PCInconType{\PCAsc{\PCMV}{\TMV'}}}{\TMV}{\ctx'}
  }
\end{mathpar}
